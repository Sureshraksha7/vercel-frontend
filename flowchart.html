<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://structure-backend-d6a4.onrender.com';
    const token = localStorage.getItem('access_token');
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');

    const companyNameEl = document.querySelector('#company-node h1');
    const flowchartContainer = document.getElementById('flowchart-container');
    const loader = document.getElementById('flowchart-loader');

    const addMenuButton = document.getElementById('add-menu-btn');
    const saveButton = document.getElementById('save-button');
    const saveToDashboardButton = document.getElementById('save-to-dashboard-button');
    const chatInput = document.getElementById('chat-input');
    const regenerateBtn = document.getElementById('regenerate-btn');
    const chatMessages = document.getElementById('chat-messages');

    let currentProjectStructure = null;

    const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
    const loginUrl = `${currentPath}/index.html`;
    const dashboardUrl = `${currentPath}/dashboard.html`;

    if (!token) return window.location.href = loginUrl;
    if (!projectId) {
        alert('No project ID specified. Redirecting to dashboard.');
        return window.location.href = dashboardUrl;
    }

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    function getIconClass(name) {
        const icons = { welcome:'fas fa-info-circle', about:'fas fa-info-circle', home:'fas fa-home',
                        support:'fas fa-headset', contact:'fas fa-headset', chat:'fas fa-comments', help:'fas fa-question-circle',
                        account:'fas fa-user-circle', profile:'fas fa-user-alt', product:'fas fa-box', store:'fas fa-store',
                        blog:'fas fa-newspaper', news:'fas fa-newspaper' };
        name = (name || '').toLowerCase();
        for (const key in icons) if (name.includes(key)) return icons[key];
        return 'fas fa-file';
    }

    function addMessage(text, isUser=false) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message flex ' + (isUser ? 'justify-end':'justify-start');
        const span = document.createElement('span');
        span.className = isUser ? 'user-message' : 'ai-message';
        span.textContent = text;
        msgDiv.appendChild(span);
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function fetchProjectData() {
        try {
            const res = await fetch(`${API_URL}/structures/${projectId}`, { headers:{ 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error(res.status === 401 ? 'Unauthorized' : 'Could not fetch project data');
            const project = await res.json();
            if (!Array.isArray(project.structure)) throw new Error("Invalid structure data (not array)");
            currentProjectStructure = project.structure;
            renderProjectStructure(project);
            regenerateBtn.disabled = false;
        } catch(e) {
            console.error(e);
            flowchartContainer.innerHTML = `<p style="color:red; padding: 1rem;">Error loading project: ${e.message}</p>`;
        } finally { if (loader) loader.remove(); }
    }

    function buildItemsHtml(items, level='menu') {
        if (!items) return '';
        let html = '<div class="tree-children">';
        items.forEach(item => {
            const name = item.menu || item.section || item.page || item.title || 'New Item';
            const icon = item.icon || getIconClass(name);
            const subsections = item.sections || item.subsections || [];
            let subHtml = '';
            if (subsections.length) {
                subHtml = buildItemsHtml(subsections, level==='menu'?'section':'subsection');
            }
            const baseClass = level==='menu'?'menu-item': level==='section'?'section-item':'subsection-item';
            const iconTag = level==='subsection'? '<i class="fas fa-info-circle info-icon"></i>' : `<i class="${icon} w-4"></i>`;
            const desc = item.description || 'No description provided.';
            html += `
                <div class="${baseClass} tree-node" data-level="${level}">
                    <div class="tree-content">
                        <span class="tree-line-leaf"></span>
                        ${iconTag}
                        <span contenteditable="false" class="item-text flex-grow">${escapeHTML(name)}</span>
                        <div class="action-bar ml-auto">
                            ${level!=='subsection'?'<button class="action-btn add-btn add-section-btn"><i class="fas fa-plus"></i></button>':''}
                            <button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i></button>
                            <button class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                            <button class="action-btn save-edit-btn hidden"><i class="fas fa-check"></i></button>
                            <button class="action-btn cancel-edit-btn hidden"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    ${level==='subsection'?`<span contenteditable="false" class="subsection-description-text item-text hidden">${escapeHTML(desc)}</span>`:subHtml}
                </div>`;
        });
        html += '</div>';
        return html;
    }

    function renderProjectStructure(project) {
        companyNameEl.textContent = escapeHTML(project.company_name);
        flowchartContainer.innerHTML = '';
        currentProjectStructure.forEach(menuItem => {
            const html = buildItemsHtml([menuItem], 'menu');
            flowchartContainer.insertAdjacentHTML('beforeend', html);
        });
    }

    function collectStructure() {
        const structure = [];
        document.querySelectorAll('#flowchart-container > .menu-item').forEach(menuNode => {
            const menuText = menuNode.querySelector(':scope > .tree-content .item-text').textContent.trim();
            const iconClass = menuNode.querySelector(':scope > .tree-content > .fas').className;
            const sections = [];
            menuNode.querySelectorAll(':scope > .tree-children > .section-item').forEach(sectionNode => {
                const sectionText = sectionNode.querySelector(':scope > .tree-content .item-text').textContent.trim();
                const subsections = [];
                sectionNode.querySelectorAll(':scope > .tree-children > .subsection-item').forEach(subNode => {
                    const subName = subNode.querySelector('.item-text').textContent.trim();
                    const subDesc = subNode.querySelector('.subsection-description-text')?.textContent.trim() || '';
                    subsections.push({ name: subName, description: subDesc });
                });
                sections.push({ section: sectionText, subsections });
            });
            structure.push({ menu: menuText, icon: iconClass, sections });
        });
        return structure;
    }

    async function saveChanges(button) {
        button.disabled = true;
        const origText = button.innerHTML;
        button.innerHTML = 'Saving...';
        try {
            const payload = { company_name: companyNameEl.textContent.trim(), structure: collectStructure() };
            const res = await fetch(`${API_URL}/structures/${projectId}`, {
                method:'PUT',
                headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error((await res.json()).error || 'Failed to save');
            button.innerHTML = 'Saved!';
            setTimeout(()=>button.innerHTML = origText, 2000);
        } catch(e) {
            console.error(e);
            alert(`Error: ${e.message}`);
            button.innerHTML = origText;
        } finally { button.disabled = false; }
    }

    async function handleRegeneration() {
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        addMessage(userInput, true);
        regenerateBtn.disabled = chatInput.disabled = true;
        const origBtn = regenerateBtn.innerHTML;
        regenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        chatInput.value = '';
        try {
            const payload = {
                company_name: companyNameEl.textContent.trim(),
                current_structure: collectStructure(),
                refinement_prompt: userInput
            };
            const res = await fetch(`${API_URL}/structures/refine/${projectId}`, {
                method:'POST',
                headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error((await res.json()).error || 'Failed to refine structure.');
            const newProject = await res.json();
            currentProjectStructure = newProject.structure;
            renderProjectStructure(newProject);
            addMessage("Structure updated successfully! Please review the changes in the left panel.");
        } catch(e) { addMessage(`Error: ${e.message}`); console.error(e); }
        finally { regenerateBtn.innerHTML = origBtn; regenerateBtn.disabled = chatInput.disabled = false; chatInput.focus(); }
    }

    // --- Event Listeners ---
    addMenuButton.addEventListener('click', ()=>{
        const html = `<div class="menu-item tree-node" data-level="menu">
            <div class="tree-content"><span class="tree-line-leaf"></span><i class="fas fa-home w-4"></i>
            <span class="item-text" contenteditable="false">New Menu Item</span>
            <div class="action-bar ml-auto">
                <button class="action-btn add-btn add-section-btn"><i class="fas fa-plus"></i></button>
                <button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i></button>
                <button class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                <button class="action-btn save-edit-btn hidden"><i class="fas fa-check"></i></button>
                <button class="action-btn cancel-edit-btn hidden"><i class="fas fa-times"></i></button>
            </div></div><div class="tree-children"></div></div>`;
        flowchartContainer.insertAdjacentHTML('beforeend', html);
        flowchartContainer.lastElementChild.scrollIntoView({behavior:'smooth'});
    });

    flowchartContainer.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        const node = e.target.closest('.tree-node');
        if (!btn || !node) return;

        if (btn.classList.contains('delete-btn') && confirm('Are you sure you want to delete this item?')) node.remove();

        else if (btn.classList.contains('edit-btn') || btn.classList.contains('save-edit-btn') || btn.classList.contains('cancel-edit-btn')) {
            const editMode = btn.classList.contains('edit-btn');
            const saveMode = btn.classList.contains('save-edit-btn');
            const cancelMode = btn.classList.contains('cancel-edit-btn');
            const spans = node.querySelectorAll(':scope > .tree-content .item-text, :scope > .subsection-description-text');
            const actionBar = node.querySelector('.action-bar');

            if(editMode){ spans.forEach(s=>{s.dataset.originalValue=s.textContent; s.contentEditable=true;}); actionBar.querySelector('.edit-btn').classList.add('hidden'); actionBar.querySelector('.delete-btn').classList.add('hidden'); actionBar.querySelector('.save-edit-btn').classList.remove('hidden'); actionBar.querySelector('.cancel-edit-btn').classList.remove('hidden'); actionBar.querySelector('.add-btn')?.classList.add('hidden'); spans[0].focus(); }
            if(saveMode){ spans.forEach(s=>{s.contentEditable=false; s.removeAttribute('data-original-value');}); actionBar.querySelector('.edit-btn').classList.remove('hidden'); actionBar.querySelector('.delete-btn').classList.remove('hidden'); actionBar.querySelector('.save-edit-btn').classList.add('hidden'); actionBar.querySelector('.cancel-edit-btn').classList.add('hidden'); actionBar.querySelector('.add-btn')?.classList.remove('hidden'); }
            if(cancelMode){ spans.forEach(s=>{s.contentEditable=false; s.textContent=s.dataset.originalValue; s.removeAttribute('data-original-value');}); actionBar.querySelector('.edit-btn').classList.remove('hidden'); actionBar.querySelector('.delete-btn').classList.remove('hidden'); actionBar.querySelector('.save-edit-btn').classList.add('hidden'); actionBar.querySelector('.cancel-edit-btn').classList.add('hidden'); actionBar.querySelector('.add-btn')?.classList.remove('hidden'); }
        }

        const addSectionBtn = e.target.closest('.add-section-btn');
        const addSubsectionBtn = e.target.closest('.add-subsection-btn');
        if(addSectionBtn || addSubsectionBtn){
            const isSub = !!addSubsectionBtn;
            const parentNode = isSub ? node : node;
            const childrenContainer = parentNode.querySelector(':scope > .tree-children');
            const html = isSub?`<div class="subsection-item tree-node" data-level="subsection"><div class="tree-content"><span class="tree-line-leaf"></span><i class="fas fa-info-circle info-icon"></i><span contenteditable="false" class="subsection-title item-text text-gray-600">New Subsection</span><div class="action-bar ml-auto"><button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i></button><button class="action-btn delete-btn"><i class="fas fa-trash"></i></button><button class="action-btn save-edit-btn hidden"><i class="fas fa-check"></i></button><button class="action-btn cancel-edit-btn hidden"><i class="fas fa-times"></i></button></div></div><span contenteditable="false" class="subsection-description-text item-text hidden">Click edit to add a description.</span></div>`:
            `<div class="section-item tree-node" data-level="section"><div class="tree-content"><span class="tree-line-leaf"></span><i class="fas fa-folder text-gray-500 w-4"></i><span contenteditable="false" class="item-text flex-grow">New Section</span><div class="action-bar"><button class="action-btn add-btn add-subsection-btn"><i class="fas fa-plus"></i></button><button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i></button><button class="action-btn delete-btn"><i class="fas fa-trash"></i></button><button class="action-btn save-edit-btn hidden"><i class="fas fa-check"></i></button><button class="action-btn cancel-edit-btn hidden"><i class="fas fa-times"></i></button></div></div><div class="tree-children"></div></div>`;
            childrenContainer.insertAdjacentHTML('beforeend', html);
        }

        if(e.target.closest('.info-icon')){
            node.querySelector('.subsection-description-text')?.classList.toggle('hidden');
        }
    });

    saveButton.addEventListener('click', e=>saveChanges(e.target));
    saveToDashboardButton.addEventListener('click', async e=>{ if(await saveChanges(e.target)) window.location.href = dashboardUrl; });
    regenerateBtn.addEventListener('click', handleRegeneration);
    chatInput.addEventListener('input', ()=>regenerateBtn.disabled = chatInput.value.trim().length===0);
    chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); if(!regenerateBtn.disabled) handleRegeneration(); } });

    fetchProjectData();
});
</script>
