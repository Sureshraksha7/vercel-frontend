<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background:#f9fafb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
        th { background:#f3f4f6; cursor:pointer; }
        .model-tag-display.gemini { background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px; }
        .model-tag-display.openai { background:#ede9fe; color:#7c3aed; padding:2px 6px; border-radius:4px; }
        .action-btn { cursor:pointer; border:none; background:none; font-size:16px; margin-right:5px; }
        #profile-icon { width:32px;height:32px;border-radius:50%;background:#2563eb;color:white;display:flex;align-items:center;justify-content:center;margin-right:8px; }
        #logout-button { margin-left: 10px; cursor:pointer; }
        .active-sort i { font-weight:bold; }
        #pagination-controls-container { margin-top:15px; display:flex; gap:5px; }
        .pagination-btn { padding:5px 10px; border:1px solid #ddd; cursor:pointer; background:#f3f4f6; border-radius:4px; }
        .pagination-btn.active { background:#2563eb;color:white;border-color:#2563eb; }
        #search-input, #model-filter { padding:5px; margin-right:10px; }
    </style>
</head>
<body>
    <header style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;">
            <div id="profile-icon"></div>
            <span id="user-name"></span>
        </div>
        <button id="logout-button">Logout</button>
    </header>

    <div style="margin-top:20px;">
        <input type="text" id="search-input" placeholder="Search by company or category">
        <select id="model-filter">
            <option value="all">All Models</option>
            <option value="gemini">Gemini 2.5 Flash</option>
            <option value="openai">GPT-4o mini</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th data-sort-key="company_name">Company <i class="fas fa-sort"></i></th>
                <th data-sort-key="category">Category <i class="fas fa-sort"></i></th>
                <th data-sort-key="num_pages">Pages <i class="fas fa-sort"></i></th>
                <th data-sort-key="model_used">Model <i class="fas fa-sort"></i></th>
                <th data-sort-key="created_at">Created At <i class="fas fa-sort"></i></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="projects-table-body">
            <tr><td colspan="6" style="text-align:center;color:#64748b;">Loading projects...</td></tr>
        </tbody>
    </table>

    <div id="pagination-controls-container"></div>

    <script>
        const API_URL = '';
        const projectsTableBody = document.getElementById('projects-table-body');
        const userNameEl = document.getElementById('user-name');
        const profileIconEl = document.getElementById('profile-icon');
        const logoutButton = document.getElementById('logout-button');
        const modelFilterEl = document.getElementById('model-filter');
        const paginationContainer = document.getElementById('pagination-controls-container');
        const searchInputEl = document.getElementById('search-input');

        const ITEMS_PER_PAGE = 20;
        let allProjectsCache = [];
        let filteredProjectsCache = [];
        let currentPage = 1;
        let currentSort = { key: 'created_at', direction: 'desc' };

        function getModelDisplayName(key) {
            if (!key) return 'Gemini 2.5 Flash';
            if (key === 'gemini') return 'Gemini 2.5 Flash';
            if (key === 'openai') return 'GPT-4o mini';
            return 'Unknown Model';
        }

        function getModelClass(key) {
            if (!key || key === 'gemini') return 'gemini';
            if (key === 'openai') return 'openai';
            return '';
        }

        function escapeHTML(str) {
            return str ? str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]) : '';
        }

        function checkToken(loginUrl) {
            const token = localStorage.getItem('access_token');
            console.log('Access token:', token);
            if(!token) console.warn('No token found, redirect disabled for debug.');
            return token;
        }

        async function fetchProfile(loginUrl) {
            const token = checkToken(loginUrl);
            if(!token) return;

            try {
                const response = await fetch(`${API_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!response.ok) throw new Error('Unauthorized');
                const user = await response.json();
                const nameParts = user.name.split(' ');
                const firstName = nameParts[0];
                const lastName = nameParts.length>1 ? nameParts[nameParts.length-1]:'';
                userNameEl.textContent = firstName;
                profileIconEl.textContent = ((firstName[0]||'')+(lastName[0]||'')).toUpperCase()||firstName[0];
            } catch(error) {
                console.error('Error fetching profile:', error);
                localStorage.removeItem('access_token');
                console.warn('Redirect disabled for debug.');
            }
        }

        async function fetchProjects() {
            const token = localStorage.getItem('access_token');
            if(!token) return;

            projectsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#64748b;">Loading projects...</td></tr>`;

            try {
                const response = await fetch(`${API_URL}/structures`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!response.ok) throw new Error('Could not fetch projects');
                allProjectsCache = await response.json();
                currentPage = 1;
                applyFilter(modelFilterEl.value, searchInputEl.value);
            } catch(error) {
                console.error('Error fetching projects:', error);
                projectsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#ef4444;">Failed to load projects.</td></tr>`;
            }
        }

        function applyFilter(selectedModelKey, searchTerm) {
            let filteredProjects = allProjectsCache;
            if(selectedModelKey!=='all') filteredProjects = filteredProjects.filter(p => (p.model_used||'gemini')===selectedModelKey);
            if(searchTerm && searchTerm.trim()!==''){
                const lower = searchTerm.toLowerCase();
                filteredProjects = filteredProjects.filter(p=>p.company_name.toLowerCase().includes(lower) || p.category.toLowerCase().includes(lower));
            }
            sortProjects(filteredProjects);
            filteredProjectsCache = filteredProjects;
            const maxPages = Math.ceil(filteredProjectsCache.length/ITEMS_PER_PAGE);
            if(currentPage>maxPages && maxPages>0) currentPage=maxPages;
            else if(maxPages===0) currentPage=1;
            renderProjectsTable(filteredProjects);
            renderPaginationControls();
        }

        function renderProjectsTable(projects){
            const start = (currentPage-1)*ITEMS_PER_PAGE;
            const end = start+ITEMS_PER_PAGE;
            const toRender = projects.slice(start,end);
            if(toRender.length===0){
                projectsTableBody.innerHTML=`<tr><td colspan="6" style="text-align:center;color:#64748b;padding:20px;">No projects found.</td></tr>`;
                return;
            }
            projectsTableBody.innerHTML=toRender.map(p=>{
                const date=new Date(p.created_at);
                const friendly=date.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
                return `<tr data-id="${p.id}" data-name="${escapeHTML(p.company_name)}">
                    <td>${escapeHTML(p.company_name)}</td>
                    <td>${escapeHTML(p.category)}</td>
                    <td>${String(p.num_pages)}</td>
                    <td><span class="model-tag-display ${getModelClass(p.model_used)}">${getModelDisplayName(p.model_used)}</span></td>
                    <td>${friendly}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewProject(${p.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn delete-icon" onclick="deleteProject(event,${p.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function sortProjects(projects){
            const key=currentSort.key, dir=currentSort.direction==='asc'?1:-1;
            projects.sort((a,b)=>{
                let valA=a[key],valB=b[key];
                if(key==='created_at'){valA=new Date(valA);valB=new Date(valB);}
                else if(key==='num_pages'){valA=Number(valA);valB=Number(valB);}
                else{valA=String(valA||'').toLowerCase(); valB=String(valB||'').toLowerCase();}
                if(valA<valB) return -1*dir;
                if(valA>valB) return 1*dir;
                return 0;
            });
        }

        window.handleLogout = async function(loginUrl){
            const token=localStorage.getItem('access_token');
            if(token){
                try{ await fetch(`${API_URL}/logout`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});}catch(e){console.error(e);}
            }
            localStorage.removeItem('access_token');
            console.log('Logout done, redirect disabled for debug.');
        }

        function updateSortIcons(){
            document.querySelectorAll('th[data-sort-key]').forEach(th=>{
                th.classList.remove('active-sort');
                const icon=th.querySelector('i');
                if(th.dataset.sortKey===currentSort.key){ th.classList.add('active-sort'); icon.className=currentSort.direction==='desc'?'fas fa-sort-down':'fas fa-sort-up'; }
                else{ icon.className='fas fa-sort'; }
            });
        }

        function renderPaginationControls(){
            const maxPages=Math.ceil(filteredProjectsCache.length/ITEMS_PER_PAGE);
            paginationContainer.innerHTML='';
            if(maxPages<=1) return;
            for(let i=1;i<=maxPages;i++){
                const btn=document.createElement('button');
                btn.textContent=i;
                btn.className='pagination-btn'+(i===currentPage?' active':'');
                btn.addEventListener('click',()=>{currentPage=i; renderProjectsTable(filteredProjectsCache); renderPaginationControls();});
                paginationContainer.appendChild(btn);
            }
        }

        window.viewProject=function(id){ window.location.href=`./flowchart.html?id=${id}`; }
        window.deleteProject=function(e,id){ console.log('Delete clicked for id',id); /* implement your delete */ }

        document.addEventListener('DOMContentLoaded',()=>{
            const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const loginUrl = `${currentPath}/index.html`;
            fetchProfile(loginUrl);
            fetchProjects();

            modelFilterEl.addEventListener('change',e=>{currentPage=1;applyFilter(e.target.value,searchInputEl.value);});
            searchInputEl.addEventListener('input',e=>{currentPage=1;applyFilter(modelFilterEl.value,e.target.value);});
            logoutButton.addEventListener('click',()=>handleLogout(loginUrl));

            document.querySelectorAll('th[data-sort-key]').forEach(header=>{
                header.addEventListener('click',()=>{
                    const sortKey=header.dataset.sortKey;
                    if(currentSort.key===sortKey) currentSort.direction=currentSort.direction==='asc'?'desc':'asc';
                    else{ currentSort.key=sortKey; currentSort.direction=(sortKey==='created_at'||sortKey==='num_pages')?'desc':'asc'; }
                    currentPage=1;
                    updateSortIcons();
                    applyFilter(modelFilterEl.value,searchInputEl.value);
                });
            });

            updateSortIcons();
        });
    </script>
</body>
</html>
