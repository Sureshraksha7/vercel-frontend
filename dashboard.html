<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebMap Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Existing CSS from your code remains unchanged */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color:#f8fafc; color:#334155; }
.container { display:flex; height:100vh; }
/* Sidebar styles ... (unchanged) */
/* Main content styles ... (unchanged) */
/* Table, sorting, pagination styles ... (unchanged) */
</style>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header"><h1>WebMap</h1></div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="./create.html" class="nav-item"><i class="fas fa-plus"></i><span>Create a new project</span></a>
            <a href="#" class="nav-item"><i class="fas fa-life-ring"></i><span>Support</span></a>
            <a href="./profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profile</span></a>
        </nav>
        <div class="sidebar-footer">
            <a href="#" id="logout-button" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
        </div>
    </aside>
    <main class="main-content">
        <header class="header">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search by name or category...">
            </div>
            <div class="user-info">
                <span id="user-name" class="user-name">Loading...</span>
                <div id="profile-icon" class="user-avatar">L</div>
            </div>
        </header>
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Dashboard</h2>
                <p>Welcome to WebMap.</p>
            </div>
            
            <div class="filter-container mb-6 flex items-center gap-4">
                <label for="model-filter" style="font-weight: 600; color: #1e293b;">Filter by Model:</label>
                <select id="model-filter" class="search-input" style="width: auto; padding: 8px 12px;">
                    <option value="all">All Models</option>
                    <option value="gemini">Gemini 2.5 Flash</option>
                    <option value="openai">GPT-4o mini</option>
                </select>
            </div>
            
            <div class="project-table-container">
                <table id="projects-table" class="project-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort-key="company_name">Company Name <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort-key="category">Category <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort-key="num_pages">Pages <i class="fas fa-sort"></i></th>
                            <th>Model</th>
                            <th class="sortable" data-sort-key="created_at">Created At <i class="fas fa-sort"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-table-body">
                        <tr><td colspan="6" style="text-align:center; color:#64748b;">Loading projects...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls-container" class="pagination-container"></div>
        </div>
    </main>
</div>

<script>
const API_URL = ''; // <-- set backend URL
const projectsTableBody = document.getElementById('projects-table-body');
const userNameEl = document.getElementById('user-name');
const profileIconEl = document.getElementById('profile-icon');
const logoutButton = document.getElementById('logout-button');
const modelFilterEl = document.getElementById('model-filter');
const paginationContainer = document.getElementById('pagination-controls-container');
const searchInputEl = document.getElementById('search-input');

const ITEMS_PER_PAGE = 20;
let allProjectsCache = [];
let filteredProjectsCache = [];
let currentPage = 1;
let currentSort = { key:'created_at', direction:'desc' };

function getModelDisplayName(key){return key==='openai'?'GPT-4o mini':'Gemini 2.5 Flash';}
function getModelClass(key){return key==='openai'?'openai':'gemini';}
function escapeHTML(str){return str?str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]):'';}

function updateSortIcons(){
    document.querySelectorAll('th[data-sort-key]').forEach(th=>{
        th.classList.remove('active-sort');
        const icon = th.querySelector('i');
        if(th.dataset.sortKey===currentSort.key){
            th.classList.add('active-sort');
            icon.className = currentSort.direction==='desc'?'fas fa-sort-down':'fas fa-sort-up';
        }else{icon.className='fas fa-sort';}
    });
}

function sortProjects(projects){
    const key=currentSort.key,direction=currentSort.direction==='asc'?1:-1;
    projects.sort((a,b)=>{
        let valA=a[key],valB=b[key];
        if(key==='created_at'){valA=new Date(valA);valB=new Date(valB);}
        else if(key==='num_pages'){valA=Number(valA);valB=Number(valB);}
        else{valA=String(valA||'').toLowerCase(); valB=String(valB||'').toLowerCase();}
        return valA<valB?-1*direction:valA>valB?1*direction:0;
    });
}

function renderPaginationControls(){
    const totalItems = filteredProjectsCache.length;
    paginationContainer.innerHTML='';
    if(totalItems<=ITEMS_PER_PAGE) return;
    const totalPages=Math.ceil(totalItems/ITEMS_PER_PAGE);
    const createButton=(label,pageNum)=>{
        const btn=document.createElement('button');
        btn.className=`page-button ${pageNum===currentPage?'active':''}`;
        btn.innerHTML=label;
        btn.onclick=()=>{if(pageNum!==currentPage){currentPage=pageNum;renderProjectsTable(filteredProjectsCache);renderPaginationControls();}};
        return btn;
    };
    const prevBtn=createButton('<i class="fas fa-chevron-left"></i>',currentPage>1?currentPage-1:1);
    prevBtn.disabled=currentPage===1; paginationContainer.appendChild(prevBtn);
    let startPage=Math.max(1,currentPage-1); let endPage=Math.min(totalPages,currentPage+1);
    const maxVisibleButtons=5;
    if(totalPages>maxVisibleButtons){
        if(currentPage<=3){endPage=maxVisibleButtons;startPage=1;}
        else if(currentPage>totalPages-3){startPage=totalPages-maxVisibleButtons+1;endPage=totalPages;}
    } else {startPage=1;endPage=totalPages;}
    if(startPage>1){paginationContainer.appendChild(createButton('1',1)); if(startPage>2){const dots=document.createElement('span');dots.textContent='...';dots.style.padding='0 5px';paginationContainer.appendChild(dots);}}
    for(let i=startPage;i<=endPage;i++){paginationContainer.appendChild(createButton(String(i),i));}
    if(endPage<totalPages){if(endPage<totalPages-1){const dots=document.createElement('span');dots.textContent='...';dots.style.padding='0 5px';paginationContainer.appendChild(dots);}
    paginationContainer.appendChild(createButton(String(totalPages),totalPages));}
    const nextBtn=createButton('<i class="fas fa-chevron-right"></i>',currentPage<totalPages?currentPage+1:totalPages);
    nextBtn.disabled=currentPage===totalPages; paginationContainer.appendChild(nextBtn);
}

function renderProjectsTable(projects){
    const startIndex=(currentPage-1)*ITEMS_PER_PAGE;
    const endIndex=startIndex+ITEMS_PER_PAGE;
    const projectsToRender=projects.slice(startIndex,endIndex);
    if(projects.length===0){
        projectsTableBody.innerHTML=`<tr><td colspan="6" style="text-align:center; color:#64748b; padding:20px;">No projects found for the selected model.</td></tr>`;
        return;
    }
    projectsTableBody.innerHTML=projectsToRender.map(project=>{
        const modelDisplay=getModelDisplayName(project.model_used);
        const modelClass=getModelClass(project.model_used);
        const date=new Date(project.created_at);
        const friendlyDate=date.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
        return `<tr data-id="${project.id}" data-name="${escapeHTML(project.company_name)}">
            <td>${escapeHTML(project.company_name)}</td>
            <td>${escapeHTML(project.category)}</td>
            <td>${String(project.num_pages)}</td>
            <td><span class="model-tag-display ${modelClass}">${modelDisplay}</span></td>
            <td>${friendlyDate}</td>
            <td>
                <button class="action-btn view-btn" onclick="viewProject(${project.id})"><i class="fas fa-eye"></i></button>
                <button class="action-btn delete-icon" onclick="deleteProject(event, ${project.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

async function fetchProfile(loginUrl){
    const token=localStorage.getItem('access_token');
    if(!token){window.location.href=loginUrl; return;}
    try{
        const response=await fetch(`${API_URL}/profile`,{headers:{'Authorization':`Bearer ${token}`}});
        if(!response.ok) throw new Error('Unauthorized');
        const user=await response.json();
        const nameParts=user.name.split(' ');
        const firstName=nameParts[0]; const lastName=nameParts.length>1?nameParts[nameParts.length-1]:'';
        userNameEl.textContent=firstName;
        let initials=(firstName[0]+(lastName[0]||'')).toUpperCase();
        if(!lastName) initials=firstName[0];
        profileIconEl.textContent=initials;
    }catch(err){console.error(err); localStorage.removeItem('access_token'); window.location.href=loginUrl;}
}

async function fetchProjects(){
    const token=localStorage.getItem('access_token');
    if(!token) return;
    projectsTableBody.innerHTML=`<tr><td colspan="6" style="text-align:center; color:#64748b;">Loading projects...</td></tr>`;
    try{
        const response=await fetch(`${API_URL}/structures`,{headers:{'Authorization':`Bearer ${token}`}});
        if(!response.ok) throw new Error('Could not fetch projects');
        allProjectsCache=await response.json();
        currentPage=1;
        applyFilter(modelFilterEl.value, searchInputEl.value);
    }catch(err){console.error(err);projectsTableBody.innerHTML=`<tr><td colspan="6" style="text-align:center; color:#ef4444;">Failed to load projects.</td></tr>`;}
}

function applyFilter(selectedModelKey, searchTerm){
    let filteredProjects=allProjectsCache;
    if(selectedModelKey!=='all'){
        filteredProjects=allProjectsCache.filter(project=>(project.model_used||'gemini')===selectedModelKey);
    }
    if(searchTerm && searchTerm.trim()!==''){
        const lower=searchTerm.toLowerCase();
        filteredProjects=filteredProjects.filter(project=>project.company_name.toLowerCase().includes(lower)||project.category.toLowerCase().includes(lower));
    }
    sortProjects(filteredProjects);
    filteredProjectsCache=filteredProjects;
    const maxPages=Math.ceil(filteredProjectsCache.length/ITEMS_PER_PAGE);
    if(currentPage>maxPages && maxPages>0) currentPage=maxPages; else if(maxPages===0) currentPage=1;
    renderProjectsTable(filteredProjects);
    renderPaginationControls();
}

window.viewProject=function(id){window.location.href=`./flowchart.html?id=${id}`;}
window.deleteProject=async function(event,id){
    const row=event.target.closest('tr');
    const name=row.getAttribute('data-name');
    if(!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) return;
    const token=localStorage.getItem('access_token'); if(!token||!row) return;
    try{
        const response=await fetch(`${API_URL}/structures/${id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});
        if(!response.ok) throw new Error('Failed to delete project.');
        row.style.transition='all 0.3s ease-out'; row.style.opacity='0';
        setTimeout(()=>{allProjectsCache=allProjectsCache.filter(p=>p.id!==id); applyFilter(modelFilterEl.value, searchInputEl.value);},300);
    }catch(err){alert(`Error deleting project: ${err.message}`);console.error(err);}
}

window.handleLogout=async function(loginUrl){
    const token=localStorage.getItem('access_token');
    if(token){try{await fetch(`${API_URL}/logout`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});}catch(err){console.error(err);}}
    localStorage.removeItem('access_token'); window.location.href=loginUrl;
}

document.addEventListener('DOMContentLoaded',()=>{
    const currentPath=window.location.href.substring(0,window.location.href.lastIndexOf('/'));
    const loginUrl=`${currentPath}/index.html`;
    fetchProfile(loginUrl);
    fetchProjects();
    modelFilterEl.addEventListener('change', e=>{currentPage=1;applyFilter(e.target.value, searchInputEl.value);});
    searchInputEl.addEventListener('input', e=>{currentPage=1;applyFilter(modelFilterEl.value,e.target.value);});
    logoutButton.addEventListener('click',()=>handleLogout(loginUrl));
    window.addEventListener('pageshow', e=>{if(e.persisted){fetchProfile(loginUrl); fetchProjects();}});
    document.querySelectorAll('th[data-sort-key]').forEach(th=>th.addEventListener('click',()=>{
        const key=th.dataset.sortKey;
        if(currentSort.key===key) currentSort.direction=currentSort.direction==='asc'?'desc':'asc';
        else {currentSort.key=key; currentSort.direction=(key==='created_at'||key==='num_pages')?'desc':'asc';}
        currentPage=1; updateSortIcons(); applyFilter(modelFilterEl.value,searchInputEl.value);
    }));
    updateSortIcons();
});
</script>
</body>
</html>
